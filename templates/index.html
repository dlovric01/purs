<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <link rel="icon" href="/static/images/Infinity.png" />
    <link rel="stylesheet" href="/static/index/index.css">
    <meta charset="UTF-8" />
    <title>Ad infinitum</title>
    <script src="/static/index/index.js"></script>
    
  </head>
  <body>
    <img class="bgimg" src="static/images/houseee.avif" />

    <div class="appbar">
      <div>
     <a href="/"><img class="logo" src="static/images/infinity.png" class="logo" /></a>
        <div class="welcome-title">{{data[0]}} {{data[1]}}</div>
      </div>
      <div class="dropdown">
        <img
          onclick="myFunction()"
          class="logout-btn"
          src="/static/images/ios-arrow-down.png"
        />
        <div class="dropdown-content">
          {% if user.role == "admin" %}
          <a class="registerButton" href="/register-another-user">Register another user</a>
          {% endif %}
          <a class="logoutButton" href="/logout">Logout</a>
        </div>
      </div>
    </div>

    <div class="currentTemp">
      <p class="large" id="temperature">{{lastTemp}}</p>
      <p class="small">°C</p>
      <br>
      <p >Living room</p>
    </div>
    <canvas class="myChart" id="myChart"></canvas>
    <script>
      
      var temperatures = [];
      var dummySecondSensorTemperatures = []
      var dates = [];
      dbTemps = "{{temperatures}}"
        .split("[")
        .join("")
        .split("]")
        .join("")
        .replaceAll("'", "").split(',');
        dbDates = "{{dates|safe}}"
        .split("[")
        .join("")
        .split("]")
        .join("")
        .replaceAll("'", "")
        .replaceAll('h','')
        .replaceAll('m',':')
        .replaceAll('s','')
        .split(',');
      for (let index = dbTemps.length - 1; index > 0; index--) {
          temperatures.push(dbTemps[index]);
          dates.push(dbDates[index]);
          dummySecondSensorTemperatures.push(dbTemps[index]-15);
      }

      

    var myChart =  new Chart(document.getElementById("myChart").getContext("2d"), {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Living room (°C)',

              backgroundColor: [
              'rgba(255, 99, 132, 0)'
            ],
            borderColor: [
              'rgba(255,99,132,1)'
            ],
              data: temperatures,
              
            },
            {
              label: 'Basement (°C)',

              backgroundColor: [
              'rgba(255, 255, 255, 0)'
            ],
            borderColor: [
              'rgba(0,0,132,1)'
            ],
              data: dummySecondSensorTemperatures,
              
            },
          ],
        },
        options: {
          scales: {
            yAxes: [
              {
                ticks: {
                  min: 0,
                  max: parseFloat("{{lastTemp}}") + 15,
                },
              },
            ],
          },
          elements: {
            point: {
                radius: 2
            }
        }
        },
      });
      setInterval(function() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/update_temperature", true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
        temperatures.push(parseFloat(this.responseText));
        dummySecondSensorTemperatures.push(parseFloat(this.responseText)-15);
        dates.push(new Date().toLocaleTimeString());
        document.getElementById("temperature").innerHTML =
              this.responseText;
        if (temperatures.length > 20) {
              temperatures.shift();
              dates.shift();
              dummySecondSensorTemperatures.shift();
            }
        myChart.update();
      }
    };
    xhr.send();
  }, 5000);
   </script>
    
    </body>
  </body>
</html>
